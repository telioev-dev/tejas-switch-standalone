
create or replace view stitching.tejas_switch_tunnel_view as
select sa.TRAIL_ID, 
sa.USER_LABEL, 
sa.CIRCUIT_ID, 
sa.RATE, 
sa.TECHNOLOGY, 
sa.SPECIFICATION, 
sa.PATH_TYPE, 
sa.VENDOR, 
tv.user_label as TOPOLOGY, 
sa.A_END_DROP_NODE, 
sa.Z_END_DROP_NODE,
sa.A_END_DROP_PORT, 
sa.Z_END_DROP_PORT, 
null as SEQUENCE, 
null as CHANNEL,
tv.A_END_NODE as A_END_NODE, 
tv.Z_END_NODE as Z_END_NODE, 
tv.A_END_PORT as A_END_PORT, 
tv.Z_END_PORT as Z_END_PORT, 
'NE2NE' as TOPOLOGY_TYPE, 
tv.CIRCLE, 
null as SRF_ID, 
null as PATH_ID, 
sysdate as LAST_MODIFIED from stitching.TEJAS_SWITCH_TUNNEL sa
join stitching.TEJAS_SWITCH_TOPOLOGY tv on sa.a_end_drop_node = tv.a_end_node and sa.z_end_drop_node = tv.z_end_node
and sa.a_end_drop_port = tv.a_end_port and sa.z_end_drop_port = tv.z_end_port;


create or replace view stitching.tejas_switch_sia_wo_tunnel as
WITH numbered AS (
  SELECT 
    id,
    a_end_drop_node,
    a_end_drop_port,
    a_end_node,
    a_end_port,
    circle,
    circuit_id,
    path_type,
    rate,
    specification,
    technology,
    topology,
    topology_type,
    trail_id,
    user_label,
    vendor,
    ROW_NUMBER() OVER (PARTITION BY user_label ORDER BY a_end_drop_node, a_end_drop_port) AS rn
  FROM stitching.tejas_switch_trail
),
a_nodes AS (
  SELECT 
    id,
    a_end_drop_node,
    a_end_drop_port,
    a_end_node,
    a_end_port,
    circle,
    circuit_id,
    path_type,
    rate,
    specification,
    technology,
    topology,
    topology_type,
    trail_id,
    user_label,
    vendor,
    rn
  FROM numbered
  WHERE MOD(rn, 2) = 1
),
z_nodes AS (
  SELECT 
    id AS z_id,
    a_end_drop_node AS z_end_drop_node,
    a_end_drop_port AS z_end_drop_port,
    a_end_node AS z_end_node,
    a_end_port AS z_end_port,
    user_label AS z_user_label,
    rn
  FROM numbered
  WHERE MOD(rn, 2) = 0
)
SELECT 
  a.id,
  a.a_end_drop_node,
  a.a_end_drop_port,
  a.a_end_node,
  a.a_end_port,
  a.circle,
  a.circuit_id,
  a.path_type,
  a.rate,
  a.specification,
  a.technology,
  a.topology,
  a.topology_type,
  a.trail_id,
  a.user_label,
  a.vendor,
  z.z_end_drop_node,
  z.z_end_drop_port,
  z.z_end_node,
  z.z_end_port
FROM a_nodes a
LEFT JOIN z_nodes z
  ON a.user_label = z.z_user_label AND a.rn + 1 = z.rn;

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "STITCHING"."TEJAS_SWITCH_SIA" ("TRAIL_ID", "USER_LABEL", "CIRCUIT_ID", "RATE", "TECHNOLOGY", "SPECIFICATION", "PATH_TYPE", "VENDOR", "TOPOLOGY", "A_END_DROP_NODE", "Z_END_DROP_NODE", "A_END_DROP_PORT", "Z_END_DROP_PORT", "SEQUENCE", "CHANNEL", "A_END_NODE", "Z_END_NODE", "A_END_PORT", "Z_END_PORT", "TOPOLOGY_TYPE", "CIRCLE", "SRF_ID", "PATH_ID", "LAST_MODIFIED") AS 
  select sa.TRAIL_ID, 
sa.USER_LABEL, 
sa.CIRCUIT_ID, 
sa.RATE, 
sa.TECHNOLOGY, 
sa.SPECIFICATION, 
sa.PATH_TYPE, 
sa.VENDOR, 
tv.user_label as TOPOLOGY, 
sa.A_END_DROP_NODE, 
sa.Z_END_DROP_NODE,
sa.A_END_DROP_PORT, 
sa.Z_END_DROP_PORT, 
null as SEQUENCE, 
null as CHANNEL,
tv.a_end_drop_node as A_END_NODE, 
tv.z_end_drop_node as Z_END_NODE, 
tv.a_end_drop_port as A_END_PORT, 
tv.z_end_drop_port as Z_END_PORT, 
tv.TOPOLOGY_TYPE, 
tv.CIRCLE, 
null as SRF_ID, 
null as PATH_ID, 
sysdate as LAST_MODIFIED from stitching.tejas_switch_sia_wo_tunnel sa
join stitching.tejas_switch_tunnel tv on tv.trail_id = sa.trail_id;

